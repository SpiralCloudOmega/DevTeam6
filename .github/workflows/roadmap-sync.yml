name: Roadmap Sync (Autonomous Planning)

on:
  schedule:
    # Run every 6 hours
    - cron: '0 */6 * * *'
  workflow_dispatch:
    inputs:
      force_update:
        description: 'Force update even if no changes detected'
        required: false
        default: 'false'
        type: boolean

permissions:
  contents: write
  issues: write
  pull-requests: read

jobs:
  sync-roadmap:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '20'

      - name: Calculate Project Progress
        id: progress
        env:
          GH_TOKEN: ${{ github.token }}
        run: |
          echo "Calculating project progress metrics..."
          
          # Get repository statistics
          TOTAL_COMMITS=$(git rev-list --count HEAD)
          CONTRIBUTORS=$(git shortlog -sn --all | wc -l)
          LAST_COMMIT_DATE=$(git log -1 --format=%ci)
          
          # Get open issues count
          OPEN_ISSUES=$(gh issue list --state open --json number --jq 'length')
          CLOSED_ISSUES=$(gh issue list --state closed --json number --jq 'length')
          
          # Get PR stats
          OPEN_PRS=$(gh pr list --state open --json number --jq 'length')
          MERGED_PRS=$(gh pr list --state merged --json number --jq 'length' 2>/dev/null || echo "0")
          
          # Calculate progress based on milestones
          # This is a simplified calculation - could be enhanced with actual milestone tracking
          
          # Define phase weights (7 phases total)
          TOTAL_PHASES=7
          COMPLETED_PHASES=4  # Foundation, Expansion, Visual, Interactive
          IN_PROGRESS_PHASES=1  # GenUI
          
          # Calculate overall progress
          PROGRESS=$(echo "scale=0; ($COMPLETED_PHASES * 100 / $TOTAL_PHASES) + ($IN_PROGRESS_PHASES * 50 / $TOTAL_PHASES)" | bc)
          
          echo "progress=$PROGRESS" >> $GITHUB_OUTPUT
          echo "commits=$TOTAL_COMMITS" >> $GITHUB_OUTPUT
          echo "contributors=$CONTRIBUTORS" >> $GITHUB_OUTPUT
          echo "open_issues=$OPEN_ISSUES" >> $GITHUB_OUTPUT
          echo "closed_issues=$CLOSED_ISSUES" >> $GITHUB_OUTPUT
          echo "open_prs=$OPEN_PRS" >> $GITHUB_OUTPUT
          echo "merged_prs=$MERGED_PRS" >> $GITHUB_OUTPUT
          echo "last_update=$LAST_COMMIT_DATE" >> $GITHUB_OUTPUT
          
          echo "Progress: $PROGRESS%"
          echo "Total Commits: $TOTAL_COMMITS"
          echo "Contributors: $CONTRIBUTORS"

      - name: Generate Roadmap Badge SVG
        run: |
          mkdir -p .github/badges
          
          PROGRESS=${{ steps.progress.outputs.progress }}
          
          # Calculate color based on progress
          if [ "$PROGRESS" -ge 80 ]; then
            COLOR="#00ff88"
          elif [ "$PROGRESS" -ge 60 ]; then
            COLOR="#00f0ff"
          elif [ "$PROGRESS" -ge 40 ]; then
            COLOR="#ffcc00"
          else
            COLOR="#ff6600"
          fi
          
          # Generate SVG badge
          cat > .github/badges/roadmap-progress.svg << EOF
          <svg xmlns="http://www.w3.org/2000/svg" width="180" height="40">
            <defs>
              <linearGradient id="bg" x1="0%" y1="0%" x2="100%" y2="0%">
                <stop offset="0%" style="stop-color:#0a0a1a;stop-opacity:1" />
                <stop offset="100%" style="stop-color:#1a0a2e;stop-opacity:1" />
              </linearGradient>
              <linearGradient id="progress" x1="0%" y1="0%" x2="100%" y2="0%">
                <stop offset="0%" style="stop-color:#00f0ff;stop-opacity:1" />
                <stop offset="100%" style="stop-color:${COLOR};stop-opacity:1" />
              </linearGradient>
            </defs>
            <rect width="180" height="40" rx="8" fill="url(#bg)" stroke="#00f0ff" stroke-width="1"/>
            <text x="12" y="16" font-family="Arial,sans-serif" font-size="10" fill="#a0a0a0">ROADMAP PROGRESS</text>
            <rect x="12" y="22" width="156" height="8" rx="4" fill="#1a1a2e"/>
            <rect x="12" y="22" width="${PROGRESS}%" height="8" rx="4" fill="url(#progress)">
              <animate attributeName="width" from="0" to="${PROGRESS}%" dur="1s" fill="freeze"/>
            </rect>
            <text x="170" y="16" font-family="Arial,sans-serif" font-size="10" fill="${COLOR}" text-anchor="end">${PROGRESS}%</text>
          </svg>
          EOF
          
          echo "Generated roadmap progress badge"

      - name: Generate Phase Status Badges
        run: |
          # Generate individual phase badges
          declare -A PHASES
          PHASES[foundation]="completed:#00ff88"
          PHASES[expansion]="completed:#ff00ff"
          PHASES[visual]="completed:#00ff88"
          PHASES[interactive]="completed:#7b2fff"
          PHASES[genui]="in-progress:#ffcc00"
          PHASES[community]="planned:#666666"
          PHASES[ai-integration]="planned:#666666"
          
          for phase in "${!PHASES[@]}"; do
            IFS=':' read -r status color <<< "${PHASES[$phase]}"
            
            # Create mini badge for each phase
            cat > .github/badges/phase-${phase}.svg << EOF
          <svg xmlns="http://www.w3.org/2000/svg" width="100" height="24">
            <rect width="100" height="24" rx="4" fill="#0a0a1a" stroke="${color}" stroke-width="1"/>
            <circle cx="12" cy="12" r="4" fill="${color}"/>
            <text x="22" y="16" font-family="Arial,sans-serif" font-size="10" fill="#ffffff">${phase^^}</text>
          </svg>
          EOF
          done
          
          echo "Generated phase status badges"

      - name: Update README with Live Stats
        run: |
          PROGRESS=${{ steps.progress.outputs.progress }}
          COMMITS=${{ steps.progress.outputs.commits }}
          CONTRIBUTORS=${{ steps.progress.outputs.contributors }}
          OPEN_ISSUES=${{ steps.progress.outputs.open_issues }}
          LAST_UPDATE=$(date -u +"%Y-%m-%d %H:%M UTC")
          
          # Check if roadmap stats section exists, if not we'll add it
          if grep -q "<!-- ROADMAP-STATS-START -->" README.md; then
            # Update existing stats
            sed -i "/<!-- ROADMAP-STATS-START -->/,/<!-- ROADMAP-STATS-END -->/c\\
          <!-- ROADMAP-STATS-START -->\\
          ### üìä Live Project Status\\
          \\
          | Metric | Value |\\
          |--------|-------|\\
          | **Overall Progress** | ${PROGRESS}% |\\
          | **Total Commits** | ${COMMITS} |\\
          | **Contributors** | ${CONTRIBUTORS} |\\
          | **Open Issues** | ${OPEN_ISSUES} |\\
          | **Last Updated** | ${LAST_UPDATE} |\\
          \\
          <!-- ROADMAP-STATS-END -->" README.md
            
            echo "Updated README with live roadmap stats"
          else
            echo "Roadmap stats section not found in README, skipping update"
          fi

      - name: Commit and Push Changes
        run: |
          git config --local user.email "github-actions[bot]@users.noreply.github.com"
          git config --local user.name "github-actions[bot]"
          
          # Add generated files
          git add .github/badges/*.svg
          git add README.md || true
          
          # Check if there are changes to commit
          if git diff --staged --quiet; then
            echo "No changes to commit"
          else
            git commit -m "chore: sync roadmap progress [skip ci]

            - Updated roadmap progress badges
            - Current progress: ${{ steps.progress.outputs.progress }}%
            - Commits: ${{ steps.progress.outputs.commits }}
            - Contributors: ${{ steps.progress.outputs.contributors }}"
            
            git push
            echo "Changes committed and pushed"
          fi

      - name: Create Milestone Update Issue (if major progress)
        env:
          GH_TOKEN: ${{ github.token }}
        run: |
          PROGRESS=${{ steps.progress.outputs.progress }}
          
          # Check if we've hit a major milestone (every 25%)
          if [ "$((PROGRESS % 25))" -eq 0 ] && [ "$PROGRESS" -gt 0 ]; then
            # Check if milestone issue already exists
            EXISTING=$(gh issue list --search "Milestone: ${PROGRESS}%" --json number --jq 'length')
            
            if [ "$EXISTING" -eq 0 ]; then
              gh issue create \
                --title "üéâ Milestone Reached: ${PROGRESS}% Complete" \
                --body "## Project Milestone Achievement

          The DevTeam6 project has reached **${PROGRESS}%** completion!

          ### Current Stats
          - Total Commits: ${{ steps.progress.outputs.commits }}
          - Contributors: ${{ steps.progress.outputs.contributors }}
          - Open Issues: ${{ steps.progress.outputs.open_issues }}
          - Closed Issues: ${{ steps.progress.outputs.closed_issues }}

          ### Next Milestones
          - Complete GenUI Playground
          - Community Growth Phase
          - AI Agent Integration

          Thank you to all contributors! üöÄ" \
                --label "milestone,automated"
              
              echo "Created milestone issue"
            else
              echo "Milestone issue already exists"
            fi
          fi

  notify-on-failure:
    needs: sync-roadmap
    runs-on: ubuntu-latest
    if: always() && failure()
    steps:
      - name: Create Issue on Failure
        uses: actions/github-script@v7
        with:
          script: |
            const { owner, repo } = context.repo;
            await github.rest.issues.create({
              owner,
              repo,
              title: '‚ö†Ô∏è Roadmap Sync Workflow Failed',
              body: `The roadmap synchronization workflow failed.
              
              **Run ID:** ${context.runId}
              **Workflow:** ${context.workflow}
              
              Please investigate the failure in the [Actions tab](https://github.com/${owner}/${repo}/actions).`,
              labels: ['bug', 'automated', 'workflow-failure']
            });
